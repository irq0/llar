name: clojure tests

on:
  pull_request:
  push:
    branches:
        - main
        - 'wip/**'

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install clj-kondo
      run: |
        curl -sLO https://raw.githubusercontent.com/clj-kondo/clj-kondo/master/script/install-clj-kondo
        chmod +x install-clj-kondo
        ./install-clj-kondo --dir ~/.local/bin
        echo "$HOME/.local/bin" >> $GITHUB_PATH
    - name: Run clj-kondo
      run: clj-kondo --lint src

  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        fetch-tags: true
        filter: tree:0
    - name: Install packages
      run: sudo apt update && sudo apt install -y openjdk-25-jdk-headless leiningen
    - uses: actions/setup-node@v4
      with:
        node-version: 'lts/*'
    - name: Install npm dependencies
      run: npm install
    - name: Install dependencies
      run: lein deps
    - name: Run tests with coverage
      run: lein run -m kaocha.runner --plugin kaocha.plugin/cloverage
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./target/coverage/codecov.json
        fail_ci_if_error: false
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          target/junit.xml
          target/coverage/
    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: target/junit.xml
